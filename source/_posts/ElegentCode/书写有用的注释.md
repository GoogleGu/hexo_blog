---
title: 书写有用的注释
date: 2019-11-27 19:07:48
tags:
    - readability
---

## 1. 注释是一把双刃剑

注释并不是万能的，甚至不是必须的，注释不应去解决由糟糕代码的可读性产生的问题，如果一段代码本身就很烂，即使加上了注释也于事无补：可读性差的代码+注释远远比不上没有注释的可读性好的代码。我们要做的，是在保证代码没有问题的前提下，在必要的地方撰写注释来进一步提高可读性。如果你发现所写的注释大部分都是在向读者解释你那一团糟的代码意图，那么最好还是把代码先整理清楚再来写注释。
<!-- more -->

### 1.1. 坏的注释是如何毁掉一个项目的

注释是会撒谎的：一段代码往往会经过一段演化之后逻辑改变或是经历彻头彻尾的变化，如果在这个过程中注释没有被持续的更新的话，过期注释记录的信息与代码实质上在做的事往往是背道而驰的。在被这样的注释“欺骗”过几次以后，往往我们会对项目里的其他注释也产生不信任感，从而使整个项目的注释形同虚设。
另一方面，一些毫无意义、鹦鹉学舌的冗余注释如果充斥在项目的各个角落里，他们不仅无法对代码的可读性提供帮助，反而会将代码分割的七零八落，破坏代码的可读性。

### 1.2. 优秀的注释能够提供代码无法提供的信息

有很多信息，比如变量的作用、方法的主要目的、类的抽象意义等是可以通过代码本身清晰表达的，如果代码的可读性可以做到自解释，那么其实是不必添加注释的。但是还有一些信息，比在项目高度进行的点评式的高度、潜在的可优化点、已知的bug、写代码时选择当前实现的一些考量，这些都是注释能够额外为代码读者提供的。

## 2. 在值得注释的地方写注释

注释的最主要的意义就是在于让代码的读者（这个读者可能是其他的项目组成员，也可能是写完注释六个月以后的你）知道的和代码作者一样多，这是我们写注释时的最基本的原则。
以下是几个特别值得书写的注释。

### 2.1. 注释应当靠近它所描述的代码

请确保你所写的注释描述了离它最近的代码，不要让读者看了你的注释后还要为其中的信息去别的模块翻找其他的代码。

### 2.2. 为读者需要费劲才能获取的信息编写注释

诸如复杂处理逻辑的算法、类的返回值中的具体数据形式、复杂正则表达式的意图等，如果不写注释靠读者完全自己摸索可能会花费很长的时间，这时一行准确的注释可以提高很多的可读性。如果你发现自己经常在回顾代码的某部分复杂逻辑或是纠结返回值的具体结构时，往往代表这里可以加上一两行注释了。

### 2.3. 导演点评式的意图注释

某些时候在经历了一定的对比之后，你选择了某一种实现或数据结构来完成某项逻辑或存储某种数据，在这个过程中你决定的意图或是依据可以以注释的方式写下来，它可以是：“用set来存储，这样后面进行去重操作更为方便”，也可以是“虽然现在的这个实现时间消耗很大，但是避免了数据库卡死的问题，暂时是我们能想到的最好的办法了”，或者“这个类已经变得很臃肿了，其实我们可以将其中的追踪单号和更新单号职责隔离到单独的类中去分别管理。”

### 2.4. 警示性注释

在编写代码的时候，如果发现了某些未来可以优化的地方，某个地方发现了bug但是还没有解决，某个类中有未来要添加的特性，某个地方可能容易发生问题等，都可以用注释来标记。如果不进行相应的标记，后续的开发中很可能会把这些点漏过去，导致效率低下或是漏掉某些重要的工作。
关于标记法，可以用以下的方式来进行：

| 注释目的 | 标记 | 例子 |
| --- | --- | --- |
| 待完成任务 | TODO | TODO：添加过滤相同uuid的功能 |
| 已知BUG | FIXME | FIXME：入库时偶尔会发生SQL报错 |
| 可以优化的点 | HACK | HACK：可以将数据备份在缓存，提高读写效率 |
| 可能发生潜在问题 | DANGER | DANGER: 高并发时可能会吃光服务器内存导致崩溃 |

### 2.5. 全局性注释

全局性注释往往会出现在模块或一些重要的类中。想象以下的问题：如果项目里来了一个新人，向新人介绍项目代码的时候，你会进行哪些必要的介绍？这样的介绍往往都可以写成全局性注释放到模块代码或类注释中去。

## 3. 将注释写的更好

### 3.1. 紧凑准确

注释包含的信息量与其长度的比值应该保持在一个较高的水平，因此用词应该尽量准确精炼。比如说尽量不要用指代不清的代词，描述行为时不要用含混不清的词等（和语文和表达能力更相关一些）。如果是描述类，则应当准确地描述其应用场景和职责；描述方法，则应准备地描述其行为。

### 3.2. 用例子辅助

有的时候一大段复杂的描述比不上一个简单但恰到好处的例子来的好，比如说将涉及的输入输出例子写进注释里，但是不要让各种例子的注释充斥着项目代码，大部分的例子列举应该交给测试去完成。

### 3.3. 持续更新

在代码发生改变的时候，一定要一同将改变的内容反映到原有的注释中或是重新审视注释的必要性。过期的注释还不如没有注释，一定要保证注释是准确有效的。

### 3.4. 站在读者的角度上去思考

检查自己的注释写的是否靠谱，一个很有效的办法就是站到对项目了解不深的读代码注释的人角度上去思考。如果这样依然能读懂，通过注释获取足够的信息，那么这就是好注释，否则就说明这条注释不够好。

### 3.5. 尽管去写

如果一开始写的不好也没有关系，尽管下笔去写，但是要有意识地改进自己的注释，让其变得越来越好。

## 4. 避免垃圾注释

如果你发现自己写的注释可以归进下面的种类里，那么这样的注释还不如删掉。

### 4.1. 冗余的注释

不要为了注释而注释，不要机械重复你的代码所进行的操作，比如：

```java
transitTemplate = TransitTemplate()  // 创建中转模板
transitTemplate.setPol('SHANGHAI')  // 设置中转模板起始港
```

或是

```python
class TransitTemplate:
    """ 中转模板 """
    created_by = ''  # 创建人
    created = datetime.datetime.now()  # 创建时间 

    def __init__(created_by, created):
        """ 构造器 """
        self.created_by = created_by
        self.created = created

```

如果注释中的信息可以轻易地从代码中获取，那么这样的注释就是冗余的，应当将其去掉或是改写得能传达更多有意义的信息。

### 4.2. 复制粘贴来的注释

如果你发现你在复制粘贴别处的注释，那么通常说明你的代码出了问题，一般来说应该回过头思考一下有没有办法复用代码而不是直接进行赋值粘贴（复制粘贴代码同理）

### 4.3. 归属和签名

没有必要为自己写的代码打上烙印，特别是在协作开发时，代码的归属权其实很难界定，即使真要进行这方面的管理，也应该是由git来完成。

### 4.4. 注释掉的代码

直接把代码注释掉是最讨厌的做法，不要这么做。如果代码已经没有用了，直接删掉它，99%被注释掉的代码是不会被再用到的，而且被注释掉后放在那里别人往往是不敢随意删除的，这样的代码堆积起来会极大地破坏代码可读性。

## 5. 接口文档、类/方法注释、代码注释
